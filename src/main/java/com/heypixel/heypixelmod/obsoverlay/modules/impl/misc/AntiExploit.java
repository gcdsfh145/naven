package com.heypixel.heypixelmod.obsoverlay.modules.impl.misc;

import com.heypixel.heypixelmod.obsoverlay.events.api.EventTarget;
import com.heypixel.heypixelmod.obsoverlay.modules.Category;
import com.heypixel.heypixelmod.obsoverlay.modules.Module;
import com.heypixel.heypixelmod.obsoverlay.modules.ModuleInfo;
import com.heypixel.heypixelmod.obsoverlay.utils.PacketEvent2;
import net.minecraft.client.Minecraft;
import net.minecraft.network.chat.Component;
import net.minecraft.network.protocol.Packet;
import net.minecraft.network.protocol.game.*;

import java.net.URI;
import java.net.URISyntaxException;
import java.util.regex.Pattern;

@ModuleInfo(name = "AntiExploit", description = "AntiExploit", category = Category.MISC)
public class AntiExploit extends Module {
    private final Minecraft mc = Minecraft.getInstance();

    @EventTarget
    private void onPacket(PacketEvent2 event) {
        Packet<?> packet = event.getPacket();
        if (packet instanceof ClientboundExplodePacket clientboundexplodepacket) {
            if (Math.abs(clientboundexplodepacket.getKnockbackX()) > 99.0F
                    || Math.abs(clientboundexplodepacket.getKnockbackY()) > 99.0F
                    || Math.abs(clientboundexplodepacket.getKnockbackZ()) > 99.0F
                    || Math.abs(clientboundexplodepacket.getPower()) > 99.0F) {
                this.handleExploit("ExplosionA", event);
            }
        } else if (packet instanceof ClientboundSystemChatPacket clientboundSystemChatPacket) {
            if (Pattern.compile(".*\\$\\{[^}]*}.*").matcher(clientboundSystemChatPacket.content().getString().toLowerCase()).find()) {
                this.handleExploit("Log4jA", event);
            }
        } else if (packet instanceof ClientboundTeleportEntityPacket clientboundteleportentitypacket) {
            if (Math.abs(clientboundteleportentitypacket.getX()) > 2.9999984E7
                    || Math.abs(clientboundteleportentitypacket.getZ()) > 2.9999984E7
                    || Math.abs(clientboundteleportentitypacket.getY()) > 2.9999984E7) {
                this.handleExploit("TeleportA", event);
            }
        } else if (packet instanceof ClientboundSetCameraPacket) {
            if (!mc.player.isSpectator()) {
                this.handleExploit("CameraA", event);
            }
        } else if (packet instanceof ClientboundResourcePackPacket clientboundresourcepackpacket) {
            try {
                URI uri = new URI(clientboundresourcepackpacket.getUrl());
                String s = uri.getScheme();
                boolean flag = s.equalsIgnoreCase("level");
                boolean flag1 = s.equalsIgnoreCase("http");
                boolean flag2 = s.equalsIgnoreCase("https");
                if (!flag1 && !flag2 && !flag
                        || flag && (clientboundresourcepackpacket.getUrl().contains("..") || !clientboundresourcepackpacket.getUrl().endsWith("/resources.zip"))) {
                    this.handleExploit(flag ? "ResourcePackB" : "ResourcePackA", event);
                }
            } catch (URISyntaxException urisyntaxexception) {
                this.handleExploit("ResourcePackC", event);
            }
        } else if (packet instanceof ClientboundPlayerPositionPacket clientboundplayerpositionpacket
                && (
                Math.abs(clientboundplayerpositionpacket.getX()) > 3.0E7
                        || Math.abs(clientboundplayerpositionpacket.getY()) > 3.0E7
                        || Math.abs(clientboundplayerpositionpacket.getZ()) > 3.0E7
        )) {
            event.setCancelled(true);
            this.handleExploit("LagA", event);
        }
    }

    private void handleExploit(String reason, PacketEvent2 event) {
        if (mc.player != null) {
            mc.player.sendSystemMessage(Component.literal("[AntiExploit] " + reason));
        }
        event.setCancelled(true);
    }
}